<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Subir archivo</title>
</head>
<body>
  <h1>Procesar archivo</h1>

  <!-- Campo para seleccionar archivo -->
  <div>
    <label for="archivo">Selecciona un archivo:</label>
    <input type="file" id="archivo" />
  </div>

  <!-- Campo para escribir la palabra -->
  <div style="margin-top: 10px;">
    <label for="llave">Escribe la llave:</label>
    <input type="text" id="llave" placeholder="Escribe aqu铆" />
  </div> 
  <div style="margin-top: 10px;">
    <label for="llave2">Escribe la segunda llave:</label>
    <input type="text" id="llave2" placeholder="" />
  </div>
  <br>
  <label for="miLista">Elige el tipo:</label>
  <select id="miLista" name="miLista">
    <option value="">1</option>
    <option value="2" selected>2</option>
	<option value="3">3</option>
	<option value="4">4</option>
  </select>
  
  <!-- Bot贸n para ejecutar tu c贸digo -->
  <div style="margin-top: 20px;">
    <button id="subir" type="button" >Procesar</button>
  </div>
   <br>
   <pre id="resultado"></pre>
  <script>
    
	var ghubt = "";
	
  const OWNER = "ivanmoralescotes-ui";
  const REPO = "naviapp";
  const BRANCH = "main"; // 
	
	// Convierte ArrayBuffer a base64 (lo que exige la API de GitHub)
  function arrayBufferToBase64(buffer) {
    let binary = "";
    const bytes = new Uint8Array(buffer);
    const len = bytes.byteLength;
    for (let i = 0; i < len; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
  }
  
  function simpleStringHash(str) {//1234
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i);
      hash = (hash << 5) - hash + char;
      hash |= 0; // Convert to 32bit integer
    }
    return hash;
  } 
  
  async function getFileSha(path, token) {
      const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${encodeURIComponent(path)}`;

      const res = await fetch(url, {
        method: "GET",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Accept": "application/vnd.github+json"
        }
      });

      if (res.status === 200) {
        const data = await res.json();
        return data.sha; // sha real del archivo actual
      } else if (res.status === 404) {
        // No existe el archivo, devolvemos null
        return null;
      } else {
        const text = await res.text();
        console.error("Error al obtener sha:", text);
        throw new Error("No se pudo obtener el sha del archivo");
      }
    }

    
	  console.log("mira el hash:" + simpleStringHash("234"));
      //function procesarImagen() {
      document.getElementById("subir").addEventListener("click", async () => {
      // Obtenemos el archivo y la palabra desde el HTML
      const inputArchivo = document.getElementById('archivo');
      const inputPalabra = document.getElementById('llave');
	  const inputLlave2 = document.getElementById('llave2').value;
	  
	  if ( simpleStringHash(inputLlave2)!= 49683){
		alert("invalid secondary key");
		return;
	  }
	  
	  if ( inputPalabra.value.substring(0,2) != "cd"){
		alert("invalid key");
		return;
	  }

      const mySelectElement = document.getElementById('miLista').value; 
	
      const file = inputArchivo.files[0];   // Archivo seleccionado
      const palabra = btoa((inputPalabra.value).slice(3,-1));      // Palabra escrita

      // --- Ejemplo de uso (puedes borrar esto si quieres) ---
      console.log('Archivo seleccionado:', file);
      console.log('Palabra ingresada:', palabra);

      //  Aqu铆 dentro usa "archivo" y "palabra" con el c贸digo que ya tienes.
      // Por ejemplo:
      // miFuncionDeProcesamiento(archivo, palabra);
	  
	  if (!file) {
        alert("Primero selecciona un archivo.");
        return;
      }
	  
	  
	  try {
	  
	          // Hacemos una petici贸n a la funci贸n serverless
        fetch('/.netlify/functions/getTheToken')
            .then(response => response.json())
            .then(async (data) => {
                console.log('Token recibido:', data.token);
                // Aqu铆 podr铆as hacer algo con el token o con los datos que te devuelva la funci贸n serverless.
			      ghubt=data.token;
		
				  console.log('Token recibido2:', ghubt);
	
				  const pathInRepo = palabra + `/tem`+mySelectElement+`.jpg`;// 11121443  toDo
				  
				  // sha
				  const sha = await getFileSha(pathInRepo, ghubt);
	
				  // Leemos el archivo como ArrayBuffer
				  const arrayBuffer = await file.arrayBuffer();
				  const base64Content = arrayBufferToBase64(arrayBuffer);

				  // Ruta dentro del repo: /naviapp/{nombreArchivo}
				  //const pathInRepo = `naviapp/${file.name}`;//naviapp
				  

				  const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${encodeURIComponent(pathInRepo)}`;

				  const body = {
					message: `Subir archivo ${file.name} desde formulario HTML`,
					content: base64Content,
					branch: BRANCH
				  };
			
			      if (sha) {
                    body.sha = sha;
                  }
				  
				  const response = await fetch(url, {
					method: "PUT",
					headers: {
					  "Authorization": `Bearer ${ghubt}`,
					  "Accept": "application/vnd.github+json"
					},
					body: JSON.stringify(body)
				  });

				  const data2 = await response.json();
				  document.getElementById("resultado").textContent = JSON.stringify(data2, null, 2);

				  if (!response.ok) {
					alert("Hubo un error subiendo el archivo. Revisa la consola o el <pre>.");
				  } else {
					alert("Archivo subido correctamente a GitHub ");
				  }
		  

		
				
            })
				
				  
			      
      
    } catch (error) {
      console.error(error);
      alert("Error inesperado al subir el archivo.");
    }
	  
	  
   });
  </script>
</body>
</html>
