<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Slideshow</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      width: 100%;
      height: 100%;
      background: #000;
      font-family: system-ui, sans-serif;
    }

    #slideshow {
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      overflow: hidden;
      position: relative;
    }

    #slide-img, #slide-video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      opacity: 0;
      transition: opacity 1.2s ease-in-out;
      display: block;
      position: absolute;
      inset: 0;
    }

    #slide-html {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: min(6vh, 32px);
      opacity: 0;
      transition: opacity 1.2s ease-in-out;
      color: #fff;
    }

    #slide-html-inner {
      max-width: 700px;
      width: 100%;
      margin: 0.4rem 0;
    }

    #slide-html a {
      color: #00c3ff;
      text-decoration: none;
      font-size: clamp(1.1rem, 2.4vh, 1.6rem);
      display: block;
      margin-bottom: 8px;
    }
    #slide-html a:hover { text-decoration: underline; }

    #slide-html p {
      margin-top: 10px;
      font-size: clamp(1.1rem, 2.3vh, 1.5rem);
      line-height: 1.5;
    }

    #slide-img.show, #slide-video.show, #slide-html.show { opacity: 1; }

    #message {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: #fff;
      background: rgba(0,0,0,0.6);
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 14px;
    }

    /* Clave: lo oculto NO captura clics */
    #slide-img, #slide-video, #slide-html { pointer-events: none; }
    #slide-img.show, #slide-video.show, #slide-html.show { pointer-events: auto; }

    @media (max-width: 768px) {
      #slide-html-inner { max-width: 95%; }
      #slide-html a { font-size: 1.6rem; }
      #slide-html p { font-size: 1.5rem; line-height: 1.4; }
    }
  </style>
</head>

<body>
  <div id="slideshow">
    <img id="slide-img" src="" alt="Imagen" />

    <!-- Quité autoplay/loop para que ended funcione y para que no pause el slideshow sin que tú le des play -->
    <video id="slide-video" controls poster="https://i.imgur.com/mHZ0PKD.jpg" playsinline>
      <source src="temm.mp4" type="video/mp4" />
      Tu navegador no soporta la etiqueta <code>video</code>.
    </video>

    <div id="slide-html">
      <div id="slide-html-inner">
        <p id="verse-text">Aquí va el versículo de la Biblia.</p>
        <br>

        <a id="verse-link" href="#" target="_blank" rel="noopener noreferrer">Spotify</a><br>
        <a id="verse-link2" href="#" target="_blank" rel="noopener noreferrer">Instagram</a>
        <a id="verse-link3" href="#" target="_blank" rel="noopener noreferrer">Whatsapp</a><br>

        <p id="quote-text">Aquí va la frase.</p>
        <br>

        <p id="lucknumber-text">Aquí va el numero.</p>
        <br>

        <a id="verse-link4" href="#" rel="noopener noreferrer"><i>Ad</i></a>
      </div>
    </div>
  </div>

  <div id="message" style="display:none;"></div>

  <script src="../js/someFunctions.js"></script>
  <script>
    let verseLink  = "https://open.spotify.com/playlist/6zV9uAXv1YVor3H3m5PAej";
    let verseLink2 = "https://www.instagram.com/jhonatan_pino_?utm_source=ig_web_button_share_sheet&igsh=ZDNlZDc0MzIxNw==";
    let verseLink3 = "https://wa.me/573113068431";
    let lucknumberText  = "Número de suerte: ";
    let verseLink4 = "#";

    let slides = [
      { type: "html" }
    ];

    const imgElement   = document.getElementById("slide-img");
    const videoElement = document.getElementById("slide-video");
    const videoSource  = videoElement.querySelector("source");
    const htmlElement  = document.getElementById("slide-html");

    const verseLinkEl  = document.getElementById("verse-link");
    const verseLinkEl2 = document.getElementById("verse-link2");
    const verseLinkEl3 = document.getElementById("verse-link3");
    const verseLinkEl4 = document.getElementById("verse-link4");

    const verseTextEl  = document.getElementById("verse-text");
    const quoteTextEl  = document.getElementById("quote-text");
    const lucknumberTextEl  = document.getElementById("lucknumber-text");

    const messageBox   = document.getElementById("message");

    let currentIndex = 0;
    const displayTime = getDisplayTime(); // tu función (ej 7000)
    let slideshowTimer = null;

    // ----------------- Slideshow control -----------------
    function startSlideshow() {
      stopSlideshow();
      slideshowTimer = setInterval(() => {
        nextSlide();
      }, displayTime);
    }

    function stopSlideshow() {
      if (slideshowTimer) {
        clearInterval(slideshowTimer);
        slideshowTimer = null;
      }
    }

    function nextSlide() {
      if (!slides.length) return;
      currentIndex = (currentIndex + 1) % slides.length;
      console.log("currentIndex:", currentIndex);
      showSlide(currentIndex);
    }

    // Pausa slideshow cuando el video se reproduce
    videoElement.addEventListener("play", () => {
      stopSlideshow();
    });

    // Reanuda y pasa al siguiente slide cuando termina el video
    videoElement.addEventListener("ended", () => {
      startSlideshow();
      nextSlide();
    });

    function showMessage(text) {
      messageBox.textContent = text;
      messageBox.style.display = "block";
    }

    // ----------------- Tu lógica existente (startAll) -----------------
    const parts = location.pathname.split("/").filter(p => p !== "");
    const penultima = parts[parts.length - 2];
    console.log("penultima:" + penultima);

    let thegist ="b10ff3e6d9a8dd1d680d62c6d964590b";
    const thefilename ="prop" + penultima + ".txt";
    thegist = getGistId(thefilename);

    async function startAll() {
      await fetch('https://gist.githubusercontent.com/ivanmoralescotes-ui/' + thegist + '/raw/' + thefilename)
        .then(r => r.text())
        .then(r2 => {
          console.log("the object:" + r2);
          const props = JSON.parse(r2);

          const mostrarVersiculo = props.versiculo;
          const mostrarMotivacional = props.motivacional;
          const mostrarNumeroSuerte = props.numerosuerte;

          const theinstagram = props.instagram;
          const thewhatsapp = props.whatsapp;
          const thespotify = props.spotify;

          const thepublicidad = props.linkpublicidad;
          const nombrepublicidad = props.nombrepublicidad;

          const theimages = props.images;
          let imagesList = props.images;

          if (theimages != null && theimages.length > 0) {
            console.log("first image:" + imagesList[0]);

            let cuentaImagen = 1;

            for (const unaimagen of imagesList) {
              console.log("iimagen " + unaimagen);

              if (unaimagen != "" && unaimagen.length > 4) {
                let theType = "image";

                if (unaimagen.toLowerCase().endsWith("jpg") ||
                    unaimagen.toLowerCase().endsWith("jpeg")) {
                  const imgg = new Image();
                  imgg.src = unaimagen;
                } else if (unaimagen.toLowerCase().endsWith("mp4")) {
                  // (esto ya está bien así)
                  theType = "video";
                  console.log("a videoo");
                }

                if (slides.length > cuentaImagen) {
                  slides[cuentaImagen] = { type: theType, file: unaimagen };
                } else {
                  slides.push({ type: theType, file: unaimagen });
                }
                cuentaImagen++;
              }
            }
          }

          if (mostrarVersiculo != "si" && mostrarMotivacional != "si"
              && (theinstagram == "" || theinstagram == "no")
              && (thewhatsapp == "" || thewhatsapp == "no")
              && (thespotify == "" || thespotify == "no")
              && mostrarNumeroSuerte != "si"
              && (thepublicidad == "" || thepublicidad == "no")) {
            console.log("nohtml");
            slides.shift();
          }

          verseTextEl.style.display = (mostrarVersiculo == "si") ? "block" : "none";
          quoteTextEl.style.display = (mostrarMotivacional == "si") ? "block" : "none";

          if (theinstagram != "" && theinstagram != "no") {
            verseLinkEl2.style.display = "block";
            verseLink2 = theinstagram;
          } else {
            verseLinkEl2.style.display = "none";
          }

          if (thewhatsapp != "" && thewhatsapp != "no") {
            verseLinkEl3.style.display = "block";
            verseLink3 = "https://wa.me/" + thewhatsapp;
          } else {
            verseLinkEl3.style.display = "none";
          }

          if (thespotify != "" && thespotify != "no") {
            verseLinkEl.style.display = "block";
            verseLink = "https://open.spotify.com/playlist/" + thespotify;
          } else {
            verseLinkEl.style.display = "none";
          }

          lucknumberTextEl.style.display = (mostrarNumeroSuerte == "si") ? "block" : "none";

          if (thepublicidad != "" && thepublicidad != "no") {
            verseLinkEl4.style.display = "block";
            verseLink4 = thepublicidad;
          } else {
            verseLinkEl4.style.display = "none";
          }

          if (nombrepublicidad != "" && nombrepublicidad != "no") {
            verseLinkEl4.innerHTML = "<i>" + nombrepublicidad + "</i>";
          } else {
            verseLinkEl4.innerHTML = "Ad";
          }
        });
    }

    // ----------------- Mostrar slides (con pausa de video al cambiar) -----------------
    function showSlide(index) {
      if (!slides.length) {
        showMessage("No hay slides configurados.");
        return;
      }

      const slide = slides[index];

      // Oculta todo (fade-out)
      imgElement.classList.remove("show");
      htmlElement.classList.remove("show");
      videoElement.classList.remove("show");

      // Detén y resetea video al cambiar de slide (CLAVE)
      videoElement.pause();
      videoElement.currentTime = 0;

      // Si NO es video, asegúrate de que el slideshow esté corriendo
      // (por si venías de un video que lo pausó)
      if (slide.type !== "video") startSlideshow();

      setTimeout(() => {
        if (slide.type === "image") {
          console.log("it is image");

          imgElement.onload = () => imgElement.classList.add("show");
          imgElement.src = slide.file;
          imgElement.alt = slide.file;

        } else if (slide.type === "video") {
          console.log("it is video");

          videoElement.addEventListener("loadeddata", () => {
            videoElement.classList.add("show");
          }, { once: true });

          videoSource.src = slide.file;
          videoElement.load();

          // No autoplay: el usuario le da play con el control.
          // Cuando le dé play, el listener "play" pausará el slideshow.

        } else if (slide.type === "html") {
          console.log("it is html");

          verseLinkEl.href  = verseLink;
          verseLinkEl2.href = verseLink2;
          verseLinkEl3.href = verseLink3;
          verseLinkEl4.href = verseLink4;

          const quoteNumber = getRandomNumber(0, (quotes.length - 1));
          const versiculoNumber = getRandomNumber(0, (versiculos.length - 1));

          quoteTextEl.textContent = quotes[quoteNumber];
          verseTextEl.textContent = versiculos[versiculoNumber];

          lucknumberTextEl.textContent = lucknumberText + obtenerNumeroAleatorio();

          htmlElement.classList.add("show");
        }
      }, 500);
    }

    async function initSlideshow() {
      if (slides.length === 0) {
        showMessage("No hay slides configurados.");
        return;
      }

      console.log("starting");
      await startAll();

      currentIndex = 0;
      showSlide(currentIndex);

      // Arranca el timer normal (se pausa cuando el usuario reproduce el video)
      startSlideshow();
    }

    window.addEventListener("load", initSlideshow);
  </script>
</body>
</html>
