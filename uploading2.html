<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Updating</title>
  
   <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      color: #111827;
      display: flex;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 480px;
    }

    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px 18px 20px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.12);
    }

    h1 {
      font-size: 1.4rem;
      text-align: center;
      margin: 0 0 12px;
      color: #111827;
    }

    .field {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    label {
      font-size: 0.95rem;
      color: #374151;
    }

    input[type="file"],
    input[type="text"],
	input[type="checkbox"],
    input[type="password"],
    select {
      font-size: 1rem;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      outline: none;
      width: 100%;
      background-color: #f9fafb;
    }

    input:focus,
    select:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.18);
      background-color: #ffffff;
    }

    #subir {
      width: 100%;
      margin-top: 18px;
      padding: 12px;
      border-radius: 999px;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      background: #2563eb;
      color: white;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.12s ease;
    }

    #subir:active {
      transform: scale(0.98);
      box-shadow: 0 3px 12px rgba(37, 99, 235, 0.35);
    }

    #subir:hover {
      background: #1d4ed8;
    }
	
	
	button.btn-alto {
		padding: 14px 18px  ; /* más alto en celular */
		min-height: 44px;          /* tamaño táctil recomendado */
  line-height: 1.1;
  -webkit-appearance: none;  /* iPhone: evita que ignore/“reinterprete” el padding */
  appearance: none;
	}

    #resultado {
      margin-top: 16px;
      padding: 10px 12px;
      min-height: 80px;
      background: #111827;
      color: #e5e7eb;
      border-radius: 10px;
      font-size: 0.85rem;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
  
</head>
<body>

  <script src="../js/someFunctions.js"></script>
  
  
  
  <!-- for the local environment:-->
  <script src="js/someFunctions.js"></script>
  <div class="container">
    <div class="card">
      <h1>Updating page (with <a href="https://imgur.com/" target="_blank">imgur</a>)</h1>

      <!-- Campo para seleccionar archivo -->
      <!--<div class="field">
        <label for="archivo">Selecciona un archivo</label>
        <input type="file" id="archivo" />
      </div>-->

      <!-- Campo para escribir la llave -->
      <div class="field">
        <label for="llave">Your code</label>
        <input type="text" id="llave" placeholder="" maxlength="85"
           value=""		/>
      </div>

      <!-- Campo para escribir la clave -->
      <div class="field">
	  
        <label for="clave2">Your key&nbsp;&nbsp;<a href="javascript:void(0);" onclick="useKey();">></a></label>
        <input type="password" id="clave2" placeholder="" maxlength="16" 
             value="" /> 
      </div>
      <button id="consultarprops" type="button" class="btn-alto" style="display:none;" >Read</button>&nbsp;&nbsp;
	  <button id="consultarpropsFire" type="button" class="btn-alto">Read</button>&nbsp;&nbsp;
	  
	  
	  <button id="limpiarprops" type="button" class="btn-alto">Clean</button>&nbsp;&nbsp;
	  <button id="defaultimages" type="button" class="btn-alto">Default</button>
	  &nbsp;&nbsp;
	  <button id="irapagina" type="button" class="btn-alto" style="display:none;">Go</button>
      <!-- Lista desplegable -->
      <!--<div class="field">
        <label for="miLista">Elige el tipo</label>
        <select id="miLista" name="miLista">
          <option value="">1</option>
          <option value="2" selected>2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10">10</option>
          <option value="11">11</option>
		  <option value="12">12</option>
		  <option value="13">13</option>
		  <option value="14">14</option>
		  <option value="15">15</option>
		  <option value="16">16</option>
        </select>
      </div>-->
	  
	  <div class="field">
        <label for="listaspotify">Spotify List</label>
        <input type="text" id="listaspotify" placeholder="" title="ejemplo: 6zV9uAXv1YVor3H3m5PAej" maxlength="120" />
      </div>
	  
	  <div class="field">
        <label for="tuinstagram">Instagram Link</label>
        <input type="text" id="tuinstagram" placeholder="" value="" 
		    maxlength="200" />
      </div>
	  
	  <div class="field">
        <label for="tuwhatsapp">Whatsapp</label>
        <input type="text" id="tuwhatsapp" placeholder="" value="" 
		    maxlength="15" />
      </div>
	  <div class="field">
        <label for="tuspalabras">Words</label>
        <input type="text" id="tuspalabras" placeholder="" value="" 
		    maxlength="150" />
      </div>
	  
	  
	  <div class="field">
	    <label for="linkpublicidad">Additional Link</label>
        <input type="text" id="linkpublicidad" placeholder="" value="" />
      </div>
	  <div class="field">
	    <label for="nombrepublicidad">Link Name</label>
        <input type="text" id="nombrepublicidad" placeholder="" value="" />
      </div>
	  <div class="field">
        <label for="tullave">*New key</label>
        <input type="password" id="tullave" placeholder="" value="" 
		    maxlength="20" />
      </div>
	  <div class="field">
        <label for="confirmatullave">*Confirm new key</label>
        <input type="password" id="confirmatullave" placeholder="" value="" 
		    maxlength="20" />
      </div>
	  <div class="field">
        <label for="tunombre">Name</label>
        <input type="text" id="tunombre" placeholder="" value="" 
		    maxlength="20" />
      </div>
	  
	  <br>
	  <div class="field">
	    Verse?<input type="checkbox" name="quieresversiculo" 
		       value="value1" id="quieresversiculo">			   
      </div>
	  <br>
	  <div class="field">
	    Lucky number?<input type="checkbox" name="quieresnumerosuerte" 
		       value="value1" id="quieresnumerosuerte">		   
      </div>
	  <br>
	  <div class="field">
	    Quote?<input type="checkbox" name="quieresmotivacional" 
		       id="quieresmotivacional">		   
      </div>
	  <!--<div class="field">
	    AI?<input type="checkbox" name="quieresia" 
		       id="quieresia">		   
      </div>-->
	  
	  <div class="field">
	    English?<input type="checkbox" name="esingles" 
		       id="esingles">		   
      </div>
	  
	  <div class="field">
	     AI
	     <select id="tipoia">
		    <option value=""></option>
			<option value="news">&nbsp;news</option>
			<option value="controv">&nbsp;controv</option>
			<option value="joke">&nbsp;joke</option>
			<option value="tipo4">&nbsp;tipo4</option>
			
		 </select>
	  </div>
	  
	  <div class="field">
	     Seconds
	     <select id="segundosslide">
			<option value="5">&nbsp;5</option>
			<option value="8" selected="selected" >&nbsp;8</option>
			<option value="11">&nbsp;11</option>
			<option value="14">&nbsp;14</option>
			<option value="30">&nbsp;30</option>
		 </select>
	  </div>
	  
	  <div class="field">
	    <label for="imagenes">Images</label>
        <textarea id="imagenes" rows="9"></textarea>
      </div>
	  
      <!-- Botón para ejecutar tu código -->
      <button id="exsubir" type="button" style="display:none;">Save</button>
	  <button id="subir" type="button"  style="display:none;" >Save</button>

      <!--<pre id="resultado"></pre>-->
    </div>
	<br>
	<div class="field">
	    <label for="urlimagen">Url:</label>
        <input type="text" id="urlimagen" placeholder="" 
		  value="" />		
		<select id="imagenPorAjustar">
		    <option value="0">&nbsp;1</option>
			<option value="1">&nbsp;2</option>
			<option value="2">&nbsp;3</option>
			<option value="3">&nbsp;4</option>
			<option value="4">&nbsp;5</option>
			<option value="5">&nbsp;6</option>
-			<option value="6">&nbsp;7</option>
			<option value="7">&nbsp;8</option>
			<option value="8">&nbsp;9</option>
		</select>
		<button id="usarimagen" type="button" class="btn-alto">Use</button>
		<button id="ajustarimagen" type="button" class="btn-alto">Jpg</button>
		<button id="defaultimg" type="button" class="btn-alto">default</button>
		<button id="ajustarmp4" type="button" class="btn-alto">Mp4</button>
		<button id="iraunaimagen" type="button" class="btn-alto">Go</button>
    </div>
	<br>
	<div><center><a href="https://imgur.com/upload" target="_blank">imgur</a></center></div>
	<br>
	<!--<div><center><a href="https://huggingface.co/spaces/huggingface-projects/QR-code-AI-art-generator" target="_blank">qface</a></center></div>-->
	
	<!--<div><center><a href="https://app.v2.qrcodekit.com" target="_blank">qkit</a></center></div>-->
	<div><center><a href="https://scanqr.org/#scan" target="_blank">scan</a></center></div>
	
	<div><br><center>573113068430</center></div>
	<div><center><a href="https://navi111.netlify.app/i?f=WMTExMTM0NDg=I" target="_blank">Note</a></center></div>
	
  </div>

  <script>
      function useKey(){
	      document.getElementById("tullave").value=document.getElementById("clave2").value;
		  document.getElementById("confirmatullave").value=document.getElementById("clave2").value;
	  }  
  </script>
  
  <script type="module">
    import { obtenerDatos } from "./js/functionss.js";
	import { obtenerFila } from "./js/functionss.js";
	import { actualizarCampo } from "./js/functionss.js";
	import { upsertConId } from "./js/functionss.js";
	import { insertMany } from "./js/functionss.js";
    import { consultarPorId } from "./js/functionss.js";
	
	//consultarPorId("prop11111726");
	//obtenerDatos();
	//obtenerFila("prop11111357");//c11111357??   c11111726??
	//upsertConId("prop11111603","abc","def","wW");
    //insertMany();
	
  
      console.log("c11121197");
	  const params = new URLSearchParams(window.location.search);
      const urlCode = params.get('cd');
	  if (urlCode != null && urlCode != ""){
		document.getElementById('llave').value = urlCode;
	  }
	
	  const isLocal = getIsLocal();
	  let ghubt = "";
	  let theTimestamp = "?";
	  	
	  const OWNER = "ivanmoralescotes-ui";
	  const REPO = "naviapp";
	  const BRANCH = "main"; //

      const defaultKey = "1539232";//2
	  const mainKeyy = "1691068";//1   1508448,   1691068	  
		
	  // Convierte ArrayBuffer a base64 (lo que exige la API de GitHub)
	  function arrayBufferToBase64(buffer) {
		let binary = "";
		const bytes = new Uint8Array(buffer);
		const len = bytes.byteLength;
		for (let i = 0; i < len; i++) {
		  binary += String.fromCharCode(bytes[i]);
		}
		return btoa(binary);
	  }
	  
	    
	  function simpleStringHash(str) {
		let hash = 0;
		for (let i = 0; i < str.length; i++) {
		  const char = str.charCodeAt(i);
		  hash = (hash << 5) - hash + char;
		  hash |= 0; // Convert to 32bit integer
		}
		//console.log("hash: z9"+hash+"r5");
		return hash;
	  } 
  
	  function getFileExtension(filename) {
		const lastDotIndex = filename.lastIndexOf('.');
		if (lastDotIndex === -1) {
		  return ''; // No extension found
		}
		return filename.substring(lastDotIndex + 1);
	  }
	  
	  // not used
	  async function getFileSha(path, token) {
		  const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${encodeURIComponent(path)}`;

		  const res = await fetch(url, {
			method: "GET",
			headers: {
			  "Authorization": `Bearer ${token}`,
			  "Accept": "application/vnd.github+json"
			}
		  });

		  if (res.status === 200) {
			const data = await res.json();
			return data.sha; // sha real del archivo actual
		  } else if (res.status === 404) {
			// No existe el archivo, devolvemos null
			return null;
		  } else {
			const text = await res.text();
			console.error("Error al obtener sha:", text);
			throw new Error("No se pudo obtener el sha del archivo");
		  }
      }
    
	
	  // to check
	  function validateInput(){
		  const inputLlave2 = document.getElementById('clave2').value.slice(1);
		  const inputLlave = document.getElementById('llave');

		  if ( inputLlave.value.substring(0,1) != "c" || inputLlave.value.length > 100 ){
			alert("Invalid key.");
			return false;
		  }
		  if ( //simpleStringHash(inputLlave2)!= 49683 && 
				inputLlave2.length > 100 || inputLlave2.length < 3 ){
			alert("Invalid secondary key.");
			return false;
		  }
		  return true;
	  }
 	  console.log("startt");
	
      function borrarFila(texto, filaABorrar) {
	    const filas = texto.split('\n');

	    // filaABorrar es 1, 2, 3... (no 0)
	    const indice = filaABorrar;

	    if (indice < 0 || indice >= filas.length) {
		  return texto; // fuera de rango, no hace nada
	    }

	    filas.splice(indice, 1);
	    return filas.join('\n');
	  }

	  

	  // * Para subir gist
      async function  subirJsonEnGist(theGist, theObject, theFileName,  theTokenn){	     
		const url = `https://api.github.com/gists/${theGist}`;
	    console.log("theTokenn:" + theTokenn + ".url:" + url);
		const response = await fetch(url, {
				method: 'PATCH',
				headers: {
				  'Accept': 'application/vnd.github+json',
				  'Authorization': `Bearer ${theTokenn}`,
				  "X-GitHub-Api-Version": "2022-11-28",
				  "Content-Type": "application/json"
				},
				body: JSON.stringify({
					  //"testing", 
					  
					  files: {
						[theFileName]: { content: JSON.stringify(theObject,null,2) }, // filename debe ser el nombre ACTUAL
					  },
					} , null, 2)
			  
			  });

			  if (!response.ok) {
				console.error('Error al actualizar el Gist:', response.status, response.statusText);
				return null;
			  }
			  const data = await response.json();
			  console.log("response when updating: " + JSON.stringify(data) );	
			  return data;
	  }
	  
	  // * Para subir el json
      async function  subirJsonEnFire(theObject, theFileName){	     
		//const url = `https://api.github.com/gists/${theGist}`;
	    //console.log("theTokenn:" + theTokenn + ".url:" + url);
		//const response = await fetch(url, {
		//		method: 'PATCH',
		//		headers: {
		//		  'Accept': 'application/vnd.github+json',
		//		  'Authorization': `Bearer ${theTokenn}`,
		//		  "X-GitHub-Api-Version": "2022-11-28",
		//		  "Content-Type": "application/json"
		//		},
		//		body: JSON.stringify({
		//			  files: {
		//				[theFileName]: { content: JSON.stringify(theObject,null,2) },//filename debe ser nombreactual
		//			  },
		//			} , null, 2)	  
		//	  });
			
		upsertConId("prop"+theFileName, theObject.nombre, theObject.whatsapp, theObject.instagram,
           theObject.tipoIa,theObject.lastupdate,theObject.isEnglish,theObject.segundosslide,theObject.palabras,theObject.clave,"",
	       theObject.versiculo,theObject.motivacional,theObject.numerosuerte,theObject.spotify,theObject.linkpublicidad,theObject.nombrepublicidad,theObject.images);
		   
		/*const newGist = {
				  instagram: document.getElementById("tuinstagram").value,
				  whatsapp: document.getElementById("tuwhatsapp").value,
				  nombre: document.getElementById("tunombre").value,
				  clave: laclave,
				  motivacional: quieresMotivacional,
				  				  
				  tipoIa: document.getElementById("tipoia").value,
				  
				  versiculo: quiereVersiculo,
				  numerosuerte: quiereNumeroSuerte,
				  spotify:  document.getElementById("listaspotify").value ,
				  linkpublicidad: document.getElementById("linkpublicidad").value,
				  nombrepublicidad: document.getElementById("nombrepublicidad").value,
				  images: imagesToUpdate ,
				  palabras: document.getElementById("tuspalabras").value,
				  lastupdate: new Date(),
				  isEnglish: esIngles,
				  segundosslide: document.getElementById("segundosslide").value
	 			};*/		   
		   

   		//if (!response.ok) {
		//if (  error  ){ //toDo
			//console.error('Error al actualizar el json');
			//return null;
		//}
		
		//const data = "";//await response.json();		
		//console.log("response when updating: " + JSON.stringify(data) );	
		//return data;
		
	  }


      // * Para leer gist ya teniendo el token
	  async function leerJsonDeGist( theKeyFromUser ,  theToken ) {
	
			let gistId= ''; //ivanmoralescotes-ui   b10ff3e6d9a8dd1d680d62c6d964590b
			//72b4874243e1613ba3dd8b9eb9d8e9d9
			
			console.log("theKeyFromUser:"+theKeyFromUser);
			const filenamepart = atob( theKeyFromUser ); //11121197
			console.log("filenamepart:"+filenamepart);

			//let token = ;
			const FILE_NAME = "prop" + filenamepart + ".txt";
			
			gistId = getGistId(FILE_NAME);

			  const url = `https://api.github.com/gists/${gistId}`;
			  console.log("theToken:"+theToken);
			  const response = await fetch(url, {
				method: 'GET',
				headers: {
				  'Accept': 'application/vnd.github+json',
				  'Authorization': `Bearer ${theToken}`  // tambi¨¦n puede ser `token ${TOKEN}`
				}
			  });

			  if (!response.ok) {
				console.error('Error al leer el Gist:', response.status, response.statusText);
				return null;
			  }

			  const data = await response.json();

			  // Obtener el archivo espec¨ªfico
			  const file = data.files[FILE_NAME];
			  if (!file) {
				console.error('No encontro archivo "${FILE_NAME}" en el Gist');
				return null;
			  }

			  // El contenido del archivo viene como texto
			  const jsonText = file.content;
			  console.log("jsonText:"+jsonText);
			  // Parsear el JSON
			  let jsonData;
			  try {
				jsonData = JSON.parse(jsonText);
			  } catch (e) {
				console.error('Error parseando el JSON:', e);
				return null;
			  }

			  console.log('JSON leido desde Gist:', jsonData);
			  return jsonData;
	  }
	  
	  
	  async function leerJsonDeFire( theKeyFromUser ,  theToken ) {	
			let gistId= '';			
			console.log("theKeyFromUser:"+theKeyFromUser);
			const filenamepart = atob( theKeyFromUser ); //11121197
			console.log("filenamepart:"+filenamepart);

			const FILE_NAME = "prop" + filenamepart + ".txt";//cWMTExMTE3MjY=i
					
			let jsonText = await consultarPorId( "prop" + filenamepart );
			console.log("jsonText :"+jsonText);
			// Parsear el JSON
			let jsonData;
			try {
				jsonData = jsonText; //JSON.parse(jsonText);
			} catch (e) {
				console.error('Error parseando el JSON:', e);
				return null;
			}
			console.log('JSON leido desde Gist:', jsonData);
			return jsonData;
			
			/*
			gistId = getGistId(FILE_NAME);

			  const url = `https://api.github.com/gists/${gistId}`;
			  console.log("theToken:"+theToken);
			  const response = await fetch(url, {
				method: 'GET',
				headers: {
				  'Accept': 'application/vnd.github+json',
				  'Authorization': `Bearer ${theToken}`  
				}
			  });

			  if (!response.ok) {
				console.error('Error al leer el Gist:', response.status, response.statusText);
				return null;
			  }

			  const data = await response.json();
			  const file = data.files[FILE_NAME];
			  if (!file) {
				console.error('No encontro archivo "${FILE_NAME}" en el Gist');
				return null;
			  }*/

			  // El contenido del archivo viene como texto
			  //const jsonText = file.content;
			  
	  }
	  

        // Event listeners
	  
        document.getElementById("limpiarprops").addEventListener("click", async () => {
			document.getElementById('urlimagen').value="";
			document.getElementById('imagenes').value="";
			document.getElementById('listaspotify').value="";
			document.getElementById('tuwhatsapp').value="";
			document.getElementById('tuinstagram').value="";
			document.getElementById('tunombre').value="";
			document.getElementById('tullave').value="";
			document.getElementById('confirmatullave').value="";
			
			document.getElementById('tuspalabras').value="";
			
			document.getElementById('clave2').value="";
			document.getElementById('linkpublicidad').value="";
			document.getElementById('nombrepublicidad').value="";
			
			document.getElementById('quieresversiculo').checked=false;
			document.getElementById('quieresnumerosuerte').checked=false;
			document.getElementById('quieresmotivacional').checked=false;
			//document.getElementById('quieresia').checked=false;
			document.getElementById('esingles').checked=false;
			//document.getElementById('quieresia2').checked=false;
			document.getElementById('tipoia').value="";
		
        });
	        
	  
	    let llavee = document.getElementById("llave");
	    llavee.addEventListener("blur", () => {
		
			if (llavee.value.length > 3 && llavee.value.startsWith("c") 
					&& llavee.value.endsWith("??") && !llavee.value.endsWith("???")){
				console.log("to process the key");
								
				
				llavee.value="cW" + btoa( llavee.value.slice(1,-2) ) + "i";
				
			} else if ( llavee.value.endsWith("???") ) {
			    if (llavee.length > 12){
					alert("k: " + atob( llavee.value.slice(2, -5) ).slice(3)  );
				}else{
                    alert("k: " + atob( llavee.value.slice(2, -4) )  );
                }				
				llavee.value = llavee.value.slice(0,-3);
				
			}else if ( llavee.value.endsWith("..") && !llavee.value.endsWith("...") ) {
				navigator.clipboard.writeText(
				  "https://navi111.netlify.app/i?f=" + llavee.value.slice( 1,-2 ) )
				  .then(() => {
					alert("Copied.");
					llavee.value = llavee.value.slice(0,-2);
				  })
				  .catch(err => {
					console.error("Error al copiar:", err);
				  });
			}else if ( llavee.value.endsWith("...") ) {
				alert("https://navi111.netlify.app/i?f=" + llavee.value.slice( 1,-3 ) );
				llavee.value = llavee.value.slice(0,-3);
			}else if ( llavee.value.endsWith("--") ) {
				
				navigator.clipboard.writeText(
					   llavee.value.slice( 1,-2 ).replace("=","-") )
				  .then(() => {
					alert("Copied.");
					llavee.value = llavee.value.slice(0,-2);
				  })
				  .catch(err => {
					console.error("Error al copiar:", err);
				  });
				  
			}
		
	    });
	  
	    let linkValue = document.getElementById("linkpublicidad");
	    linkValue.addEventListener("blur", () => {
		
		  if ( linkValue.value == "    "  || linkValue.value == "   "){
		   	  console.log("to process a key");
			
			  linkValue.value="javascript:void(0);";
		  }
	    });
	  
	    let spotifyValue = document.getElementById("listaspotify");
	    spotifyValue.addEventListener("blur", () => {		
		  if ( spotifyValue.value == "default" ){
		 	spotifyValue.value="6zV9uAXv1YVor3H3m5PAej";
		  }
	    });
		
		
	    	
	  
	    let instagramValue = document.getElementById("tuinstagram");
	    instagramValue.addEventListener("blur", () => {		
		  if ( instagramValue.value == "default" ){
			instagramValue.value="https://www.instagram.com/";
		  }
	    });
	  
	    let tullaveValue = document.getElementById("tullave");
	    tullaveValue.addEventListener("blur", () => {		
		  if ( tullaveValue.value == "   " ||  tullaveValue.value == "  "){
			tullaveValue.value=document.getElementById("clave2").value;
			document.getElementById("confirmatullave").value=document.getElementById("tullave").value;
		  }
		  
		  if ( tullaveValue.value == "ii"){
			tullaveValue.value=document.getElementById("clave2").value;
			document.getElementById("confirmatullave").value=document.getElementById("tullave").value;
			document.getElementById("subir").style.display = "inline-block";
		  }
		  
	    });
	  
	    let tunombreElement = document.getElementById("tunombre");
	    tunombreElement.addEventListener("blur", () => {		
		  if ( tunombreElement.value.endsWith("tt") ){
			alert ("t " + theTimestamp);			
		  }
		  if ( tunombreElement.value.endsWith("??") &&
		        !tunombreElement.value.endsWith("???") ){
		 	 window.open("https://huggingface.co/spaces/Oysiyl/AI-QR-code-generator" , "_blank");
		  } else if ( tunombreElement.value.endsWith("???") ){
		     window.open("https://huggingface.co/spaces/huggingface-projects/QR-code-AI-art-generator" , "_blank");
		  }
	    
	    });
	  	  
	  
	////////////////////////////////////////////////////////
		
	document.getElementById("usarimagen").addEventListener("click", async () => {	
		let currentImages = document.getElementById('imagenes').value.split((/\r?\n/));
		const  urlImagenAUsar = document.getElementById("urlimagen").value;
		const indexOfImage = document.getElementById('imagenPorAjustar').value;
		
		if (urlImagenAUsar == ""){			
			document.getElementById('imagenes').value = borrarFila(document.getElementById('imagenes').value, indexOfImage);
			console.log("deleting line");
			return;
		}			
		if ( !urlImagenAUsar.includes("http")
                  || !  (urlImagenAUsar.toLowerCase().includes(".j") 
					     || urlImagenAUsar.toLowerCase().includes(".mp4")  )				  
		   ){
			 alert("Invalid url");
		     return;
		}				
		
		if (currentImages.length > indexOfImage){
			currentImages[indexOfImage] = document.getElementById("urlimagen").value;
			
		}else {
			//alert("invalid index");
			currentImages.push(document.getElementById("urlimagen").value);
		}		
		document.getElementById('imagenes').value = currentImages.join("\n");
	});
	
	document.getElementById("defaultimages").addEventListener("click", async () => {	

		//document.getElementById('quieresversiculo').checked=true;
		document.getElementById("imagenes").value =
	         "https://i.imgur.com/ZYbySOV.jpg" +
			   "\nhttps://i.imgur.com/n9LNBpb.jpg" 
	           //"\nhttps://i.imgur.com/uVFofUl.jpg"
               //"\nhttps://i.imgur.com/E7T8pTv.jpg"+
               //"\nhttps://i.imgur.com/HA1h36w.jpg"+
               //"\nhttps://i.imgur.com/HA1h36w.jpg"
	});
	
	document.getElementById("defaultimg").addEventListener("click", async () => {
		document.getElementById("imagenes").value = "https://i.imgur.com/ZYbySOV.jpg" +
			   "\nhttps://i.imgur.com/n9LNBpb.jpg"
	});
	
	
	// to do
	document.getElementById("irapagina").addEventListener("click", async () => {	
		let thekey = document.getElementById("llave").value.slice(1);
		if ( ! validateInput() ) {
			console.log("Error de entrada..");
			return;
		}
		//alert("thekey:"+thekey);
		if (thekey.length == 6){
		   thekey = thekey.slice(1,-1);
		}
		if (isLocal){
		   window.open("http://localhost:3000/i?f=" + thekey , "_blank");
		   // http://localhost:3000/i.html?f=11121197
		   // http://localhost:3000/i?f=QUFB
		}else{
			window.open("https://navi111.netlify.app/i.html?f=" + thekey , "_blank");
		}
		console.log("ir a");
	});
		
	document.getElementById("ajustarimagen").addEventListener("click", async () => {
			  let urlimagen = document.getElementById('urlimagen').value;
			  console.log("urlimagen:"+urlimagen);
			  
			  if ( urlimagen.toLowerCase().slice(-4) != ".jpg" && 
				   urlimagen.toLowerCase().slice(-4) != ".jpeg"
				  ){				   
				 urlimagen = urlimagen + ".jpg";
			  }
			  
			  urlimagen = urlimagen.replaceAll("https://imgur.com"
				  ,"https://i.imgur.com");
			  console.log("urlimagen2:"+urlimagen);
			  document.getElementById('urlimagen').value=urlimagen;
	});
	
	document.getElementById("iraunaimagen").addEventListener("click", async () => {
			  let urlimagen = document.getElementById('urlimagen').value;
			  console.log("iraunaimagen ");
		      
             let currentImages = document.getElementById('imagenes').value.split((/\r?\n/));
			 const indexOfImage = document.getElementById('imagenPorAjustar').value;
			 
			 console.log("currentImages.length"+currentImages.length);
			 
			 if (currentImages.length > indexOfImage){			 
				const theimagee = currentImages[indexOfImage];
				window.open(theimagee, "_blank");				
			 }else{
				alert("Invalid number for that list");
			 }
	});
	
	document.getElementById("ajustarmp4").addEventListener("click", async () => {
	          let urlimagen = document.getElementById('urlimagen').value;
	          console.log("urlimagen  :"+urlimagen);
			  if ( urlimagen.toLowerCase().slice(-4) != ".mp4" 	  ){
				 urlimagen = urlimagen + ".mp4";
			  }
			  urlimagen = urlimagen.replaceAll("https://imgur.com"
				  ,"https://i.imgur.com");
			  console.log("urlimagen2 :"+urlimagen);
			  document.getElementById('urlimagen').value=urlimagen;
	});


	// * Para leer el gist pero antes de tener el token 
	document.getElementById("consultarprops").addEventListener("click", async () => { 	        
			try {
			    //toDo
			    if ( ! validateInput() ) {
					console.log("Error de entrada");
					return;
				}
			
				console.log("before getting t");				
				const tokenurl ="https://navi111.netlify.app/.netlify/functions/getTheToken";
				//  /.netlify/functions/getTheToken
				
				fetch(tokenurl)
					.then(response => response.json())
					.then(async (data) => {
						//console.log('Token recibido:', data.token);						
						ghubt=data.token;
								
						let jsonData = await leerJsonDeGist( (document.getElementById("llave").value).slice(2, -1) , ghubt );
						//console.log( "jsonData:" + JSON.stringify(jsonData) );
						
						const llave2hash = simpleStringHash(document.getElementById("clave2").value); 
						// 233 def
						
						if (llave2hash != mainKeyy 
						    && llave2hash != jsonData.clave ){
							alert("Invalid value.");
							document.getElementById("subir").style.display = "none";
							//document.getElementById("subirFire").style.display = "none";
							document.getElementById("irapagina").style.display = "none";
							return;	
						}else{
						    //document.getElementById("subir").style.visibility = "visible";
						    document.getElementById("subir").style.display = "inline-block";
							//document.getElementById("subirFire").style.display = "inline-block";
							document.getElementById("irapagina").style.display = "inline-block";							
						}
						
						if ( jsonData.versiculo == "si" ){
							document.getElementById("quieresversiculo").checked = true;
						}else{
						    document.getElementById("quieresversiculo").checked = false;
						}
						
						if ( jsonData.motivacional == "si" ){
							document.getElementById("quieresmotivacional").checked = true;
						}else{
						    document.getElementById("quieresmotivacional").checked = false;
						}

						/*if ( jsonData.ia1 && jsonData.ia1 == "si" ){
							document.getElementById("quieresia").checked = true;
						}else{
						    document.getElementById("quieresia").checked = false;
						}*/	
						
						if (jsonData.tipoIa && jsonData.tipoIa != ""){
							document.getElementById("tipoia").value = jsonData.tipoIa;
						}else{
						    document.getElementById("tipoia").value ="";
						}
						
						if ( jsonData.numerosuerte == "si" ){
							document.getElementById("quieresnumerosuerte").checked = true;
						}else{
						    document.getElementById("quieresnumerosuerte").checked = false;
						}
						
						if ( jsonData.spotify != "" && jsonData.spotify != "no"){
							document.getElementById("listaspotify").value = jsonData.spotify;
						}else{
						    document.getElementById("listaspotify").value = "";
						}
						
						if ( jsonData.instagram != "" && jsonData.instagram != "no"){
							document.getElementById("tuinstagram").value = jsonData.instagram;
						}else{
						    document.getElementById("tuinstagram").value = "";
						}
						
						if ( jsonData.whatsapp != "" && jsonData.whatsapp != "no"){
							document.getElementById("tuwhatsapp").value = jsonData.whatsapp;
						}else{
						    document.getElementById("tuwhatsapp").value = "";
						}
						
						if ( jsonData.nombre != "" && jsonData.nombre != "no"){
							document.getElementById("tunombre").value = jsonData.nombre;
						}else{
						    document.getElementById("tunombre").value = "";
						}
						
						if ( jsonData.linkpublicidad != "" && jsonData.linkpublicidad != "no"){
							document.getElementById("linkpublicidad").value = jsonData.linkpublicidad;
						}else{
						    document.getElementById("linkpublicidad").value = "";
						}
						
						if ( jsonData.nombrepublicidad != "" && jsonData.nombrepublicidad != "no"){
							document.getElementById("nombrepublicidad").value = jsonData.nombrepublicidad;
						}else{
						    document.getElementById("nombrepublicidad").value = "";
						}
						
						if ( jsonData.palabras && jsonData.palabras !="" 
						        && jsonData.palabras != "no" ){
							document.getElementById("tuspalabras").value = jsonData.palabras;
						}else{
						    document.getElementById("tuspalabras").value = "";
						}
						
						if ( jsonData.images != null && jsonData.images.length > 0){
						
							document.getElementById("imagenes").value = jsonData.images.join("\n");
							//textarea.value = frases.join("\n");
						}else{
						    document.getElementById("imagenes").value = "";
						}
						
						if ( jsonData.esingles && jsonData.esingles =="si" ){
							document.getElementById("esingles").checked = true;
						}else{
						    document.getElementById("esingles").checked = false;
						}
						
						if ( jsonData.segundosslide && jsonData.segundosslide !="" ){
							document.getElementById("segundosslide").value = jsonData.segundosslide;
						}else{
						    document.getElementById("segundosslide").value = "8";
						}
						
						if (jsonData.lastupdate){
						   console.log("upd" + jsonData.lastupdate);
						   theTimestamp = jsonData.lastupdate ;
						}
						
						document.getElementById("tullave").value =""
						document.getElementById("confirmatullave").value =""
						alert("Done.");
						
				});			
			} catch (error) {
			  console.error(error);
			  alert("Unexpected error with the file.");
			}
	});	



	// * Para leer el elemento de firebase pero antes de 
	document.getElementById("consultarpropsFire").addEventListener("click", async () => { 	        
			try {
			    if ( ! validateInput() ) {
					console.log("Error de entrada");
					return;
				}
										
				//const tokenurl ="https://navi111.netlify.app/.netlify/functions/getTheTokenFire";
				//  /.netlify/functions/getTheToken				
				//fetch(tokenurl)
					//.then(response => response.json())
					//.then(async (data) => {
						//ghubt=data.token;
							
												
						let jsonData = await leerJsonDeFire( (document.getElementById("llave").value).slice(2, -1) , ghubt );
						
						const llave2hash = simpleStringHash(document.getElementById("clave2").value); 
						
						if (llave2hash != mainKeyy 
						    && llave2hash != jsonData.clave ){
							alert("Invalid value.");
							document.getElementById("subir").style.display = "none";
							//document.getElementById("subirFire").style.display = "none";
							document.getElementById("irapagina").style.display = "none";
							return;	
						}else{
						    document.getElementById("subir").style.display = "inline-block";
							//document.getElementById("subirFire").style.display = "inline-block";
							document.getElementById("irapagina").style.display = "inline-block";							
						}
						
						if ( jsonData.versiculo == "si" ){
							document.getElementById("quieresversiculo").checked = true;
						}else{
						    document.getElementById("quieresversiculo").checked = false;
						}
						
						if ( jsonData.motivacional == "si" ){
							document.getElementById("quieresmotivacional").checked = true;
						}else{
						    document.getElementById("quieresmotivacional").checked = false;
						}				
						
						if (jsonData.tipoIa && jsonData.tipoIa != ""){
							document.getElementById("tipoia").value = jsonData.tipoIa;
						}else{
						    document.getElementById("tipoia").value ="";
						}
						
						/*if (jsonData.clave && jsonData.clave != ""){
							document.getElementById("tullave").value = jsonData.clave;
							document.getElementById("confirmatullave").value =jsonData.clave;
						}else{
						    document.getElementById("tullave").value ="";
						    document.getElementById("confirmatullave").value ="";
						}*/
						
						if ( jsonData.numerosuerte == "si" ){
							document.getElementById("quieresnumerosuerte").checked = true;
						}else{
						    document.getElementById("quieresnumerosuerte").checked = false;
						}
						
						if ( jsonData.spotify != "" && jsonData.spotify != "no"){
							document.getElementById("listaspotify").value = jsonData.spotify;
						}else{
						    document.getElementById("listaspotify").value = "";
						}
						
						if ( jsonData.instagram != "" && jsonData.instagram != "no"){
							document.getElementById("tuinstagram").value = jsonData.instagram;
						}else{
						    document.getElementById("tuinstagram").value = "";
						}
						
						if ( jsonData.whatsapp != "" && jsonData.whatsapp != "no"){
							document.getElementById("tuwhatsapp").value = jsonData.whatsapp;
						}else{
						    document.getElementById("tuwhatsapp").value = "";
						}
						
						if ( jsonData.nombre != "" && jsonData.nombre != "no"){
							document.getElementById("tunombre").value = jsonData.nombre;
						}else{
						    document.getElementById("tunombre").value = "";
						}
						
						if ( jsonData.linkpublicidad != "" && jsonData.linkpublicidad != "no"){
							document.getElementById("linkpublicidad").value = jsonData.linkpublicidad;
						}else{
						    document.getElementById("linkpublicidad").value = "";
						}
						
						if ( jsonData.nombrepublicidad != "" && jsonData.nombrepublicidad != "no"){
							document.getElementById("nombrepublicidad").value = jsonData.nombrepublicidad;
						}else{
						    document.getElementById("nombrepublicidad").value = "";
						}
						
						if ( jsonData.palabras && jsonData.palabras !="" 
						        && jsonData.palabras != "no" ){
							document.getElementById("tuspalabras").value = jsonData.palabras;
						}else{
						    document.getElementById("tuspalabras").value = "";
						}
						
						if ( jsonData.images != null && jsonData.images.length > 0){
						
							document.getElementById("imagenes").value = jsonData.images.join("\n");
						}else{
						    document.getElementById("imagenes").value = "";
						}
						
						if ( jsonData.esingles && jsonData.esingles =="si" ){
							document.getElementById("esingles").checked = true;
						}else{
						    document.getElementById("esingles").checked = false;
						}
						
						if ( jsonData.segundosslide && jsonData.segundosslide !="" ){
							document.getElementById("segundosslide").value = jsonData.segundosslide;
						}else{
						    document.getElementById("segundosslide").value = "8";
						}
						
						if (jsonData.lastupdate){
						   console.log("upd" + jsonData.lastupdate);
						   theTimestamp = jsonData.lastupdate ;
						}
						
						document.getElementById("tullave").value =document.getElementById("clave2").value;
						document.getElementById("confirmatullave").value =document.getElementById("clave2").value;
						
						alert("Done.");
						
				//});			
			} catch (error) {
			  console.error(error);
			  alert("Unexpected error with the query.");
			}
	});	


	// * Para subir gist  
	/*document.getElementById("subir").addEventListener("click", async () => {  
			
			try {
				if ( ! validateInput() || document.getElementById("tullave").value == "" ) {
					console.log("Error de entrada.");
					alert("Invalid value from user.");
					return;
				}				
				if ( document.getElementById("tullave").value !=  
						document.getElementById("confirmatullave").value) {
					console.log("Error de entrada...");
					alert("Invalid values from user.");
					return;
				}				
				//toDo
			    let quiereVersiculo = "no";
				let quiereNumeroSuerte = "no";
				let quieresMotivacional = "no";
				//let quieresIa = "no";
				let esIngles = "no";
				
				if ( document.getElementById("quieresversiculo").checked ) {
					quiereVersiculo = "si";
				}
			    if ( document.getElementById("quieresnumerosuerte").checked ) {
					quiereNumeroSuerte = "si";
				}
				if ( document.getElementById("quieresmotivacional").checked ) {
					quieresMotivacional = "si";
				}
				
				if ( document.getElementById("esingles").checked ) {
					esIngles = "si";
				}
				
				let imagesToUpdate = document.getElementById("imagenes").value.split(/\r?\n/);
				console.log("imagesToUpdate:"+imagesToUpdate);
				
				let laclave = document.getElementById("tullave").value;
				if (laclave == ""){
					laclave = defaultKey;
				}else{
					laclave = simpleStringHash(laclave);
				}
				
     			const newGist = {
				  instagram: document.getElementById("tuinstagram").value,
				  whatsapp: document.getElementById("tuwhatsapp").value,
				  nombre: document.getElementById("tunombre").value,
				  clave: laclave,
				  motivacional: quieresMotivacional,
				  				  
				  tipoIa: document.getElementById("tipoia").value,
				  
				  versiculo: quiereVersiculo,
				  numerosuerte: quiereNumeroSuerte,
				  spotify:  document.getElementById("listaspotify").value ,
				  linkpublicidad: document.getElementById("linkpublicidad").value,
				  nombrepublicidad: document.getElementById("nombrepublicidad").value,
				  images: imagesToUpdate ,
				  palabras: document.getElementById("tuspalabras").value,
				  lastupdate: new Date(),
				  isEnglish: esIngles,
				  segundosslide: document.getElementById("segundosslide").value
	 			};	
				//console.log( "newGist:" + JSON.stringify(newGist) );
				
				const keyFromUser2 =  (document.getElementById("llave").value).slice(2, -1);
		        //console.log("keyFromUser:"+keyFromUser2);
		        const filenamepart2 = atob( keyFromUser2 ); //11121197
		        //console.log("filenamepart:"+filenamepart2);
		    
		        const FILE_NAME2 = "prop" + filenamepart2 + ".txt";
    	   	    const gistId2 = getGistId(FILE_NAME2);
				//console.log("gistId2:"+gistId2);
								
				const tokenurl ="https://navi111.netlify.app/.netlify/functions/getTheToken";
				//  /.netlify/functions/getTheToken
				
				fetch(tokenurl)
					.then(response => response.json())
					.then(async (data) => {
						//console.log('Token recibido:', data.token);						
						ghubt=data.token;
						
				        let jsonData2 = await subirJsonEnGist(gistId2, newGist, FILE_NAME2 , ghubt);
						alert("ok");
				});            
				
     		} catch (error) {
			  console.error(error);
			  alert("Unexpected error updating file.");
			}
	});*/


    // * Para subir data
	document.getElementById("subir").addEventListener("click", async () => {  
			
			try {
				if ( ! validateInput() || document.getElementById("tullave").value == "" ) {
					console.log("Error de entrada.");
					//alert("Invalid value from user.");
					return;
				}				
				if ( document.getElementById("tullave").value !=  
						document.getElementById("confirmatullave").value) {
					console.log("Error de entrada...");
					alert("Invalid values from user.");
					return;
				}				
				
			    let quiereVersiculo = "no";
				let quiereNumeroSuerte = "no";
				let quieresMotivacional = "no";
				let esIngles = "no";
			
				if ( document.getElementById("quieresversiculo").checked ) {
					quiereVersiculo = "si";
				}
			    if ( document.getElementById("quieresnumerosuerte").checked ) {
					quiereNumeroSuerte = "si";
				}
				if ( document.getElementById("quieresmotivacional").checked ) {
					quieresMotivacional = "si";
				}
				
				if ( document.getElementById("esingles").checked ) {
					esIngles = "si";
				}
				
				let imagesToUpdate = document.getElementById("imagenes").value.split(/\r?\n/);
				console.log("imagesToUpdate:"+imagesToUpdate);
				
				let laclave = document.getElementById("tullave").value;
				if (laclave == ""){
					laclave = defaultKey;
				}else{
					laclave = simpleStringHash(laclave);
				}
				
     			const newGist = {
				  instagram: document.getElementById("tuinstagram").value,
				  whatsapp: document.getElementById("tuwhatsapp").value,
				  nombre: document.getElementById("tunombre").value,
				  clave: laclave,
				  motivacional: quieresMotivacional,
				  				  
				  tipoIa: document.getElementById("tipoia").value,
				  
				  versiculo: quiereVersiculo,
				  numerosuerte: quiereNumeroSuerte,
				  spotify:  document.getElementById("listaspotify").value ,
				  linkpublicidad: document.getElementById("linkpublicidad").value,
				  nombrepublicidad: document.getElementById("nombrepublicidad").value,
				  images: imagesToUpdate ,
				  palabras: document.getElementById("tuspalabras").value,
				  lastupdate: new Date(),
				  isEnglish: esIngles,
				  segundosslide: document.getElementById("segundosslide").value
	 			};	
				
				const keyFromUser2 =  (document.getElementById("llave").value).slice(2, -1);
		        const filenamepart2 = atob( keyFromUser2 ); //11121197
		        //console.log("filenamepart:"+filenamepart2);
		    
		        const FILE_NAME2 = "prop" + filenamepart2 + ".txt";
    	   	    const gistId2 = getGistId(FILE_NAME2);
				//console.log("gistId2:"+gistId2);
								
				const tokenurl ="https://navi111.netlify.app/.netlify/functions/getTheToken";
				
				//fetch(tokenurl)
					//.then(response => response.json())
					//.then(async (data) => {
						//console.log('Token recibido:', data.token);						
						//ghubt=data.token;
						
				        //let jsonData2 = await subirJsonEnFire(gistId2, newGist, FILE_NAME2 , ghubt);
						await subirJsonEnFire(newGist, filenamepart2 );
						alert("ok");
				//});            
				
     		} catch (error) {
			  console.error(error);
			  alert("Unexpected error updating data.");
			}
	});			      
	

  </script>
  
  

</body>
</html>