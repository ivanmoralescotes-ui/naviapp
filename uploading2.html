<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Updating</title>
  
   <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      color: #111827;
      display: flex;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 480px;
    }

    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px 18px 20px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.12);
    }

    h1 {
      font-size: 1.4rem;
      text-align: center;
      margin: 0 0 12px;
      color: #111827;
    }

    .field {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    label {
      font-size: 0.95rem;
      color: #374151;
    }

    input[type="file"],
    input[type="text"],
	input[type="checkbox"],
    input[type="password"],
    select {
      font-size: 1rem;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      outline: none;
      width: 100%;
      background-color: #f9fafb;
    }

    input:focus,
    select:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.18);
      background-color: #ffffff;
    }

    #subir {
      width: 100%;
      margin-top: 18px;
      padding: 12px;
      border-radius: 999px;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      background: #2563eb;
      color: white;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.12s ease;
    }

    #subir:active {
      transform: scale(0.98);
      box-shadow: 0 3px 12px rgba(37, 99, 235, 0.35);
    }

    #subir:hover {
      background: #1d4ed8;
    }
	
	
	button.btn-alto {
		padding: 14px 18px  ; /* más alto en celular */
		min-height: 44px;          /* tamaño táctil recomendado */
  line-height: 1.1;
  -webkit-appearance: none;  /* iPhone: evita que ignore/“reinterprete” el padding */
  appearance: none;
	}

    #resultado {
      margin-top: 16px;
      padding: 10px 12px;
      min-height: 80px;
      background: #111827;
      color: #e5e7eb;
      border-radius: 10px;
      font-size: 0.85rem;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
  
</head>
<body>

  <script src="../js/someFunctions.js"></script>
  <!-- for the local environment:-->
  <script src="js/someFunctions.js"></script>
  <div class="container">
    <div class="card">
      <h1>Actualizar configuraci&oacute;n</h1>

      <!-- Campo para seleccionar archivo -->
      <!--<div class="field">
        <label for="archivo">Selecciona un archivo</label>
        <input type="file" id="archivo" />
      </div>-->

      <!-- Campo para escribir la llave -->
      <div class="field">
        <label for="llave">Tu c&oacute;digo</label>
        <input type="text" id="llave" placeholder="" maxlength="20"
           value="1112"		/>
      </div>

      <!-- Campo para escribir la clave -->
      <div class="field">
        <label for="llave2">Tu clave</label>
        <input type="password" id="llave2" placeholder="" maxlength="16" 
             value=""		/>
      </div>
      <button id="consultarprops" type="button" class="btn-alto">Consultar</button>&nbsp;&nbsp;
	  <button id="limpiarprops" type="button" class="btn-alto">Limpiar</button>&nbsp;&nbsp;
	  <button id="defaultimages" type="button" class="btn-alto">Default</button>
	  &nbsp;&nbsp;
	  <button id="irapagina" type="button" class="btn-alto">Ir</button>
      <!-- Lista desplegable -->
      <!--<div class="field">
        <label for="miLista">Elige el tipo</label>
        <select id="miLista" name="miLista">
          <option value="">1</option>
          <option value="2" selected>2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10">10</option>
          <option value="11">11</option>
		  <option value="12">12</option>
		  <option value="13">13</option>
		  <option value="14">14</option>
		  <option value="15">15</option>
		  <option value="16">16</option>
        </select>
      </div>-->
	  
	  <div class="field">
        <label for="listaspotify">Lista de Spotify</label>
        <input type="text" id="listaspotify" placeholder="" title="ejemplo: 6zV9uAXv1YVor3H3m5PAej" maxlength="30" />
      </div>
	  
	  <div class="field">
        <label for="tuinstagram">Link de Instagram</label>
        <input type="text" id="tuinstagram" placeholder="" value="" 
		    maxlength="200" />
      </div>
	  
	  <div class="field">
        <label for="tuwhatsapp">Whatsapp</label>
        <input type="text" id="tuwhatsapp" placeholder="" value="" 
		    maxlength="15" />
      </div>
	  <br>
	  <div class="field">
	    Quieres vers&iacute;culo?<input type="checkbox" name="quieresversiculo" 
		       value="value1" id="quieresversiculo">			   
      </div>
	  <br>
	  <div class="field">
	    Quieres n&uacute;mero de suerte?<input type="checkbox" name="quieresnumerosuerte" 
		       value="value1" id="quieresnumerosuerte">		   
      </div>
	  
	  <div class="field">
	    <label for="linkpublicidad">Link adicional</label>
        <input type="text" id="linkpublicidad" placeholder="" value="" />
      </div>
	  <div class="field">
	    <label for="nombrepublicidad">Nombre Link adicional</label>
        <input type="text" id="nombrepublicidad" placeholder="" value="" />
      </div>
	  
	  
	  <div class="field">
	    <label for="imagenes">Im&aacute;genes</label>
        <textarea id="imagenes" rows="9"></textarea>
      </div>
	  
      <!-- Botón para ejecutar tu código -->
      <button id="subir" type="button">Guardar</button>

      <pre id="resultado"></pre>
    </div>
	<br>
	<div class="field">
	    <label for="urlimagen">Url:</label>
        <input type="text" id="urlimagen" placeholder="" 
		  value="" />		
		<select id="imagenPorAjustar">
		    <option value="0">&nbsp;1</option>
			<option value="1">&nbsp;2</option>
			<option value="2">&nbsp;3</option>
			<option value="3">&nbsp;4</option>
			<option value="4">&nbsp;5</option>
			<option value="5">&nbsp;6</option>
		</select>
		<button id="usarimagen" type="button" class="btn-alto">Usar</button>
		<button id="ajustarimagen" type="button" class="btn-alto">Ajustar Url</button>
    </div>
	<div><center><a href="https://imgur.com/" target="_blank">imgur</a></center></div>
	<div><br><br><center>573006291217</center></div>

	
  </div>

  
  <script>
    
	  let ghubt = "";
	
	  const OWNER = "ivanmoralescotes-ui";
	  const REPO = "naviapp";
	  const BRANCH = "main"; // 
		
	// Convierte ArrayBuffer a base64 (lo que exige la API de GitHub)
  function arrayBufferToBase64(buffer) {
    let binary = "";
    const bytes = new Uint8Array(buffer);
    const len = bytes.byteLength;
    for (let i = 0; i < len; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
  }
  
  function simpleStringHash(str) {//1234
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i);
      hash = (hash << 5) - hash + char;
      hash |= 0; // Convert to 32bit integer
    }
    return hash;
  } 
  
  function getFileExtension(filename) {
    const lastDotIndex = filename.lastIndexOf('.');
    if (lastDotIndex === -1) {
      return ''; // No extension found
    }
    return filename.substring(lastDotIndex + 1);
  }
  
  
  async function getFileSha(path, token) {
      const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${encodeURIComponent(path)}`;

      const res = await fetch(url, {
        method: "GET",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Accept": "application/vnd.github+json"
        }
      });

      if (res.status === 200) {
        const data = await res.json();
        return data.sha; // sha real del archivo actual
      } else if (res.status === 404) {
        // No existe el archivo, devolvemos null
        return null;
      } else {
        const text = await res.text();
        console.error("Error al obtener sha:", text);
        throw new Error("No se pudo obtener el sha del archivo");
      }
    }
    
	function validateInput(){
		  const inputLlave2 = document.getElementById('llave2').value.slice(1);
		  const inputLlave = document.getElementById('llave');

		  if ( inputLlave.value.substring(0,1) != "c" && inputLlave.value.length < 100 ){
			alert("LLave invalida.");
			return false;
		  }
	      if ( simpleStringHash(inputLlave2)!= 49683 && inputLlave2.length < 100 ){
			alert("Segunda llave invalida.");
			return false;
		  }
		  return true;
	}
		
	
	console.log("startt");
	
	// para leer gist ya teniendo el token
	async function leerJsonDeGist() {
	
			let gistId= ''; //ivanmoralescotes-ui   b10ff3e6d9a8dd1d680d62c6d964590b
			//72b4874243e1613ba3dd8b9eb9d8e9d9
			
			const keyFromUser =  (document.getElementById("llave").value).slice(2, -1);
			console.log("keyFromUser:"+keyFromUser);
			const filenamepart = atob( keyFromUser ); //11121197
			console.log("filenamepart:"+filenamepart);

			//let token = ghubt;
			const FILE_NAME = "prop" + filenamepart + ".txt";
			
			gistId = getGistId(FILE_NAME);
			//const url = `https://api.github.com/gists/${gistId}`;


			  const url = `https://api.github.com/gists/${gistId}`;
			  console.log("ghubt:"+ghubt);
			  const response = await fetch(url, {
				method: 'GET',
				headers: {
				  'Accept': 'application/vnd.github+json',
				  'Authorization': `Bearer ${ghubt}`  // tambi¨¦n puede ser `token ${TOKEN}`
				}
			  });

			  if (!response.ok) {
				console.error('Error al leer el Gist:', response.status, response.statusText);
				return null;
			  }

			  const data = await response.json();

			  // Obtener el archivo espec¨ªfico
			  const file = data.files[FILE_NAME];
			  if (!file) {
				console.error('No encontro archivo "${FILE_NAME}" en el Gist');
				return null;
			  }

			  // El contenido del archivo viene como texto
			  const jsonText = file.content;
			  console.log("jsonText:"+jsonText);
			  // Parsear el JSON
			  let jsonData;
			  try {
				jsonData = JSON.parse(jsonText);
			  } catch (e) {
				console.error('Error parseando el JSON:', e);
				return null;
			  }

			  console.log('JSON leido desde Gist:', jsonData);
			  return jsonData;
	}


    async function  subirJsonEnGist(theGist, theObject, theFileName){
	     
		const url = `https://api.github.com/gists/${theGist}`;
	    console.log("ghubt:" + ghubt + ".url:" + url);
		const response = await fetch(url, {
				method: 'PATCH',
				headers: {
				  'Accept': 'application/vnd.github+json',
				  'Authorization': `Bearer ${ghubt}`,
				  "X-GitHub-Api-Version": "2022-11-28",
				  "Content-Type": "application/json"
				},
				body: JSON.stringify({
					  //"testing", 
					  
					  files: {
						[theFileName]: { content: JSON.stringify(theObject,null,2) }, // filename debe ser el nombre ACTUAL
					  },
					} , null, 2)
			  
			  });

			  if (!response.ok) {
				console.error('Error al actualizar el Gist:', response.status, response.statusText);
				return null;
			  }

			  const data = await response.json();
			  console.log("response when updating: " + JSON.stringify(data) );	
			  return data;
	}


    document.getElementById("limpiarprops").addEventListener("click", async () => {
		document.getElementById('urlimagen').value="";
		document.getElementById('imagenes').value="";
		document.getElementById('listaspotify').value="";
		document.getElementById('tuwhatsapp').value="";
		document.getElementById('tuinstagram').value="";
		document.getElementById('llave2').value="";
		document.getElementById('linkpublicidad').value="";
		document.getElementById('nombrepublicidad').value="";
		
		document.getElementById('quieresversiculo').checked=false;
		document.getElementById('quieresnumerosuerte').checked=false;
		
    });
	
	  let llavee = document.getElementById("llave");

	  llavee.addEventListener("blur", () => {
		
		if (llavee.value.length == "11" && llavee.value.startsWith("c") 
		        && llavee.value.endsWith("88") ){
			console.log("to process the key");
			
			llavee.value="cW" + btoa( llavee.value.slice(1,-2) ) + "i";;
		}
	  });
		
	document.getElementById("usarimagen").addEventListener("click", async () => {
		let currentImages = document.getElementById('imagenes').value.split((/\r?\n/));
		const  urlImagenAUsar = document.getElementById("urlimagen").value; 
		if ( document.getElementById("urlimagen").value == "" 
		          || !urlImagenAUsar.includes("http")
                  || !urlImagenAUsar.toLowerCase().includes(".j")				  
		   ){
			 alert("Invalid url");
		     return;
		}
		
		const indexOfImage = document.getElementById('imagenPorAjustar').value;
		
		if (currentImages.length > indexOfImage){
			currentImages[indexOfImage] = document.getElementById("urlimagen").value;
			
		}else {
			//alert("invalid index");
			currentImages.push(document.getElementById("urlimagen").value);
		}		
		document.getElementById('imagenes').value = currentImages.join("\n");
	});
	
	document.getElementById("defaultimages").addEventListener("click", async () => {	

		document.getElementById('quieresversiculo').checked=true;

		document.getElementById("imagenes").value =
	         "https://i.imgur.com/Ty1npbJ.jpg" +
			   "\nhttps://i.imgur.com/cej3jvO.jpg" +
	           "\nhttps://i.imgur.com/bWmEopR.jpg"
               //"\nhttps://i.imgur.com/E7T8pTv.jpg"+
               //"\nhttps://i.imgur.com/HA1h36w.jpg"+
               //"\nhttps://i.imgur.com/HA1h36w.jpg"
	});
	
	
	document.getElementById("irapagina").addEventListener("click", async () => {	
		const thekey = document.getElementById("llave").value.slice(1,-1);
		if ( ! validateInput() ) {
			console.log("Error de entrada..");
			return;
		}
		
		window.open("https://navi111.netlify.app/i.html?f=" + thekey, "_blank");
		console.log("ir a");
	});
	
	
	document.getElementById("ajustarimagen").addEventListener("click", async () => {
			  let urlimagen = document.getElementById('urlimagen').value;
			  console.log("urlimagen:"+urlimagen);
			  
			  if ( urlimagen.toLowerCase().slice(-4) != ".jpg" && 
				   urlimagen.toLowerCase().slice(-4) != ".jpeg"
				  ){
				   
				 urlimagen = urlimagen + ".jpg";
			  }
			  
			  urlimagen = urlimagen.replaceAll("https://imgur.com"
				  ,"https://i.imgur.com");
			  console.log("urlimagen2:"+urlimagen);
			  document.getElementById('urlimagen').value=urlimagen;
		});


		// para leer el gist pero antes de tener el token 
		document.getElementById("consultarprops").addEventListener("click", async () => {  
			try {
			
			    if ( ! validateInput() ) {
					console.log("Error de entrada");
					return;
				}
			
				console.log("before getting t");				
				const tokenurl ="https://navi111.netlify.app/.netlify/functions/getTheToken";
				//  /.netlify/functions/getTheToken
				
				fetch(tokenurl)
					.then(response => response.json())
					.then(async (data) => {
						//console.log('Token recibido:', data.token);						
						ghubt=data.token;
								
						let jsonData = await leerJsonDeGist();
						//console.log( "jsonData:" + JSON.stringify(jsonData) );
						
						if ( jsonData.versiculo == "si" ){
							document.getElementById("quieresversiculo").checked = true;
						}else{
						    document.getElementById("quieresversiculo").checked = false;
						}
						
						if ( jsonData.numerosuerte == "si" ){
							document.getElementById("quieresnumerosuerte").checked = true;
						}else{
						    document.getElementById("quieresnumerosuerte").checked = false;
						}
						
						if ( jsonData.spotify != "" && jsonData.spotify != "no"){
							document.getElementById("listaspotify").value = jsonData.spotify;
						}else{
						    document.getElementById("listaspotify").value = "";
						}
						
						if ( jsonData.instagram != "" && jsonData.instagram != "no"){
							document.getElementById("tuinstagram").value = jsonData.instagram;
						}else{
						    document.getElementById("tuinstagram").value = "";
						}
						
						if ( jsonData.whatsapp != "" && jsonData.whatsapp != "no"){
							document.getElementById("tuwhatsapp").value = jsonData.whatsapp;
						}else{
						    document.getElementById("tuwhatsapp").value = "";
						}
						
						if ( jsonData.linkpublicidad != "" && jsonData.linkpublicidad != "no"){
							document.getElementById("linkpublicidad").value = jsonData.linkpublicidad;
						}else{
						    document.getElementById("linkpublicidad").value = "";
						}
						
						if ( jsonData.nombrepublicidad != "" && jsonData.nombrepublicidad != "no"){
							document.getElementById("nombrepublicidad").value = jsonData.nombrepublicidad;
						}else{
						    document.getElementById("nombrepublicidad").value = "";
						}
						
						
						if ( jsonData.images != null && jsonData.images.length > 0){
						
							document.getElementById("imagenes").value = jsonData.images.join("\n");
							//textarea.value = frases.join("\n");
						}else{
						    document.getElementById("imagenes").value = "";
						}
						alert("Consultado.");
						
				});			
			} catch (error) {
			  console.error(error);
			  alert("Error inesperado al consultar el archivo.");
			}
		});			


		//para subir gist  
		document.getElementById("subir").addEventListener("click", async () => {  
			try {
				if ( ! validateInput() ) {
					console.log("error de entrada");
					return;
				}
				
			    let quiereVersiculo = "no";
				let quiereNumeroSuerte = "no";
				if ( document.getElementById("quieresversiculo").checked ) {
					quiereVersiculo = "si";
				}
			    if ( document.getElementById("quieresnumerosuerte").checked ) {
					quiereNumeroSuerte = "si";
				}
				
				let imagesToUpdate = document.getElementById("imagenes").value.split(/\r?\n/);
				console.log("imagesToUpdate:"+imagesToUpdate);
				
     			const newGist = {
				  instagram: document.getElementById("tuinstagram").value,
				  whatsapp: document.getElementById("tuwhatsapp").value,
				  versiculo: quiereVersiculo,
				  numerosuerte: quiereNumeroSuerte,
				  spotify:  document.getElementById("listaspotify").value ,
				  linkpublicidad: document.getElementById("linkpublicidad").value,
				  nombrepublicidad: document.getElementById("nombrepublicidad").value,
				  images: imagesToUpdate /*[
						"https://i.imgur.com/cej3jvO.jpg",
						"https://i.imgur.com/1FgFHds.jpg",
						"https://i.imgur.com/bWmEopR.jpg",
						"https://i.imgur.com/E7T8pTv.jpg",
						 "https://i.imgur.com/HA1h36w.jpg",
						"https://i.imgur.com/HA1h36w.jpg"						
				  ]*/
	 			};	
				//console.log( "newGist:" + JSON.stringify(newGist) );
				
				const keyFromUser2 =  (document.getElementById("llave").value).slice(2, -1);
		        //console.log("keyFromUser:"+keyFromUser2);
		        const filenamepart2 = atob( keyFromUser2 ); //11121197
		        //console.log("filenamepart:"+filenamepart2);
		    
		        const FILE_NAME2 = "prop" + filenamepart2 + ".txt";
    	   	    const gistId2 = getGistId(FILE_NAME2);
				//console.log("gistId2:"+gistId2);
				
				
				//console.log("before getting token");				
				const tokenurl ="https://navi111.netlify.app/.netlify/functions/getTheToken";
				//  /.netlify/functions/getTheToken
				
				fetch(tokenurl)
					.then(response => response.json())
					.then(async (data) => {
						//console.log('Token recibido:', data.token);						
						ghubt=data.token;
						
				        let jsonData2 = await subirJsonEnGist(gistId2, newGist, FILE_NAME2 );
						alert("ok");
				});
						
	            
				
     		} catch (error) {
			  console.error(error);
			  alert("Error inesperado al actualizar el archivo.");
			}
		});
			
      //function procesarImagen() {
      /*document.getElementById("subir").addEventListener("click", async () => {
		  const inputArchivo = document.getElementById('archivo');
		  const inputPalabra = document.getElementById('llave');
		  const inputLlave2 = document.getElementById('llave2').value.slice(1);
		  
		  if ( simpleStringHash(inputLlave2)!= 49683){
			alert("invalid secondary key");
			return;
		  }
		  
		  if ( inputPalabra.value.substring(0,2) != "cc"){
			alert("invalid key");
			return;
		  }

		  const mySelectElement = document.getElementById('miLista').value; 
		
		  const file = inputArchivo.files[0];   // Archivo seleccionado
		  const palabra = atob((inputPalabra.value).slice(3,-1));      

		  // --- Ejemplo de uso (puedes borrar esto si quieres) ---
		  console.log('Archivo seleccionado:', file);
		  console.log('Palabra ingresada:', palabra);
		  		  
		  if (!file) {
			alert("Primero selecciona un archivo.");
			return;
		  }
		  
		  const theExtension = getFileExtension(file.name);
		  var newExtension = "jpg";
		  if ( theExtension == "MP4" || theExtension == "mp4" ){
			newExtension = "mp4";
		  }
		*/  
			
			
		/*
			const updatedContent = {
			  "files": {
				"nombre_del_archivo.txt": {
				  "content": "Este es el nuevo contenido del archivo."
				}
			  }
			};

			fetch(url, {
			  method: 'PUT',
			  headers: {
				'Authorization': `token ${token}`,
				'Content-Type': 'application/json'
			  },
			  body: JSON.stringify(updatedContent)
			})
			.then(response => response.json())
			.then(data => console.log('Gist actualizado:', data))
			.catch(error => console.error('Error actualizando el Gist:', error));
            */
		  
		    /*
		    // Hacemos una peticion a la funcion serverless
			fetch('/.netlify/functions/getTheToken')
				.then(response => response.json())
				.then(async (data) => {
					console.log('Token recibido:', data.token);
					
					  ghubt=data.token;
			
				  console.log('Token recibido2:', ghubt);
	
				  const pathInRepo = palabra + `/tem`+mySelectElement+`.`+newExtension;// 11121443  toDo
				  
				  const sha = await getFileSha(pathInRepo, ghubt);
	
				  // Leemos el archivo como ArrayBuffer
				  const arrayBuffer = await file.arrayBuffer();
				  const base64Content = arrayBufferToBase64(arrayBuffer);

				  // Ruta dentro del repo: /naviapp/{nombreArchivo}
				  //const pathInRepo = `naviapp/${file.name}`;//naviapp
				  
				  const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${encodeURIComponent(pathInRepo)}`;

				  const body = {
					message: `Subir archivo ${file.name} desde formulario HTML`,
					content: base64Content,
					branch: BRANCH
				  };
			
			      if (sha) {
                    body.sha = sha;
                  }
				  
				  const response = await fetch(url, {
					method: "PUT",
					headers: {
					  "Authorization": `Bearer ${ghubt}`,
					  "Accept": "application/vnd.github+json"
					},
					body: JSON.stringify(body)
				  });

				  const data2 = await response.json();
				  //document.getElementById("resultado").textContent = JSON.stringify(data2, null, 2);

				  if (!response.ok) {
					alert("Hubo un error subiendo el archivo.");
					document.getElementById("resultado").textContent="error";
				  } else {
					alert("Archivo subido");
					document.getElementById("resultado").textContent="ok";
				  }
		  						
				})*/
			  
   
  </script>
</body>
</html>
